var Et=Object.defineProperty,Mt=Object.defineProperties;var At=Object.getOwnPropertyDescriptors;var De=Object.getOwnPropertySymbols;var Ot=Object.prototype.hasOwnProperty,Tt=Object.prototype.propertyIsEnumerable;var be=(e,t,n)=>t in e?Et(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n,E=(e,t)=>{for(var n in t||(t={}))Ot.call(t,n)&&be(e,n,t[n]);if(De)for(var n of De(t))Tt.call(t,n)&&be(e,n,t[n]);return e},N=(e,t)=>Mt(e,At(t));var Q=(e,t,n)=>(be(e,typeof t!="symbol"?t+"":t,n),n);import{V as y,P as Ct,H as Nt,L as Fe,M as G,S as q,C as k,G as It,a as kt,A as d,E as Ke,b as ie,c as xt,d as Be,e as St,f as qe,g as Lt,h as me,i as de,j as ee,k as Pt,l as Ye,m as Je,n as fe,T as H,o as Qe,B as Dt,p as Ft,q as Bt,r as Yt,s as $t}from"./vendor.2fbe086f.js";const zt=function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerpolicy&&(a.referrerPolicy=r.referrerpolicy),r.crossorigin==="use-credentials"?a.credentials="include":r.crossorigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=n(r);fetch(r.href,a)}};zt();const Ze="sun_direct";function Rt(e){const t=new y(50,20,20),n=new y(0,0,0),o=new Ct(Ze,n,e);o.position=t;const r=new Nt("sun_indirect",n,e);o.falloffType=Fe.FALLOFF_STANDARD,r.falloffType=Fe.FALLOFF_STANDARD;const a=Wt(e,t),s=(i,_=1)=>{o.intensity=i*_,r.intensity=i/_};return s(1.5,1.5),{set_intensity:s,configure_for_earth_globe:()=>{r.dispose(),a.scaling=new y(10,10,10);const i=new y(500,200,200);a.position=i,o.position=i,o.intensity=1},sun_point_light:o}}function Wt(e,t){const n=G.CreateSphere("sun_sphere",{diameter:1},e);n.position=t;const o=new q("sun_glow_material",e);o.emissiveColor=new k(1,1,.5),n.material=o;const r=new It("glow",e);return r.intensity=10,n}function Gt(e){const t=e.getLightByName(Ze),n=new kt(1024,t);return n.usePoissonSampling=!0,n.useExponentialShadowMap=!1,n}const Ut=new Set([]);function Vt(e){e.addMeshTask("load low_poly_tree_1",null,"models/low_poly_tree/","low_poly_tree_1.glb"),e.addMeshTask("load low_poly_house_2",null,"models/low_poly_house/","low_poly_house_2.glb"),e.addMeshTask("load low_poly_arrows_1",null,"models/low_poly_arrow/","arrows_1.glb"),e.addMeshTask("load low_poly_characters",null,"models/low_poly_characters/","person_f_7.glb"),e.addMeshTask("load low_poly_characters",null,"models/low_poly_characters/","person_f_8.glb"),e.addMeshTask("load low_poly_characters",null,"models/low_poly_characters/","person_m_8.glb"),e.onTaskSuccess=t=>{if(Ht(t)){if(typeof t.sceneFilename=="string"&&t.sceneFilename.endsWith(".glb"))t.loadedMeshes.filter(o=>o.name==="__root__").forEach(o=>{o.getChildren().forEach(r=>{r.parent===o&&(r.parent=null)}),o.dispose()});else{const n=t.loadedMeshes.find(o=>Ut.has(o.name));if(!n){console.error("No parent mesh found whilst loading ",t.name);return}t.loadedMeshes.forEach(o=>{o.name!==n.name&&n.addChild(o)})}t.loadedMeshes.forEach(n=>n.visibility=0)}}}function Ht(e){return e.loadedMeshes!==void 0}function A(e){return!e||jt(e)?e:new y(...e)}function jt(e){return!!e.cross}function Xe(e,t){Kt(e)&&(e.visibility=t),e.getChildMeshes().forEach(n=>n.visibility=t)}function Kt(e){return e.visibility!==void 0}function Me(e,t,n,o={}){var l;const r=(l=e.getMeshByName(t))==null?void 0:l.clone(n,o.parent_node||null);if(!r)return console.error(`Missing mesh: ${t}`),G.CreateBox("missing "+t,{},e);const{position:a,receive_shadows:s,shadow_generator:i,visibility:_}=o;return a&&(r.position=a),r.getChildMeshes().forEach(c=>{s&&(c.receiveShadows=!0),i&&i.addShadowCaster(c)}),_!==void 0&&Xe(r,_),r}function qt(e,t,n,o={}){var l;const r=(l=e.getTransformNodeByName(t))==null?void 0:l.clone(n,o.parent_node||null);if(!r)return console.error(`Missing node: ${t}`),G.CreateBox("missing node "+t,{},e);const{position:a,receive_shadows:s,shadow_generator:i,visibility:_}=o;return a&&(r.position=a),r.getChildMeshes().forEach(c=>{s&&(c.receiveShadows=!0),i&&i.addShadowCaster(c)}),_!==void 0&&Xe(r,_),r}const Jt="low_poly_tree_1",Oe=10,Te=new d("grow_tree_y","position.y",Oe,d.ANIMATIONTYPE_FLOAT,d.ANIMATIONLOOPMODE_CONSTANT),et=new Ke;et.setEasingMode(ie.EASINGMODE_EASEOUT);Te.setEasingFunction(et);Te.setKeys([{frame:0,value:-5},{frame:Oe,value:0}]);const tt=new d("grow_tree_visibility","visibility",Oe,d.ANIMATIONTYPE_FLOAT,d.ANIMATIONLOOPMODE_CONSTANT);tt.setKeys([{frame:0,value:0},{frame:1,value:1}]);function Qt(e,t,n,o){const r=qt(e,Jt,"tree_green_"+o,{position:n,receive_shadows:!0,shadow_generator:t}),a=new xt("grow_tree_anim_group");return a.addTargetedAnimation(Te,r),r.getChildMeshes().forEach(s=>{a.addTargetedAnimation(tt,s)}),{play:()=>a.play(),node:r}}const Zt=5.1;function Xt(e,t,n,o){const r=[],a=[],i=Qt(e,t,A([0,0,0]),"thin_tree"),_=i.node.getChildMeshes()[0],l=i.node.getChildMeshes()[1];r.push(_,l);const c=Math.round(o/3),f=c**2;console.log("instance_count_2d ",f);const m=new Float32Array(16*f),h=10/Zt;let g=Be.Identity(),O=0,S=0;for(;S<c;){let x=0;for(;x<c;){const Y=S*-1*3-Math.random()*2,oe=x*-1*3-Math.random()*2,re=.4+Math.sin(Math.random()*Math.PI)*.6*h;g=Be.Identity().scale(re);const v=new St(n.x+Y,n.y,n.z+oe,1);g=g.setRow(3,v),g.copyToArray(m,O*16),++x,++O}++S}_.thinInstanceSetBuffer("matrix",m,16),l.thinInstanceSetBuffer("matrix",m,16),_.isPickable=!0,_.thinInstanceEnablePicking=!0;function w(){i.play(),a.forEach(({tree:x,delay:Y})=>{setTimeout(()=>x.play(),Y)})}return{tree_nodes:r,play:w}}function $e(e,t,n){return Math.max(Math.min(e,n),t)}qe.ShadersStore.rippleVertexShader=`precision highp float;\r
// Attributes\r
attribute vec3 position;\r
attribute vec3 normal;\r
attribute vec2 uv;\r
// Uniforms\r
uniform mat4 worldViewProjection;\r
uniform float time;\r
uniform float bubble_size;\r
// Varying\r
varying vec4 vPosition;\r
varying vec3 vNormal;\r
void main() {\r
    float inertia = 1. / pow(max(bubble_size, 1.), 0.5);\r
    float x = position.x + (sin((position.x + time) * 2. * inertia) - 0.5) * 0.1 * inertia;\r
    float y = position.y;\r
    float z = position.z + (sin((position.z + time) * 5. * inertia) - 0.5) * 0.07 * inertia;\r
    \r
    vec4 p = vec4( x, y, z, 1. );\r
    vPosition = p;\r
    vNormal = normal;\r
    gl_Position = worldViewProjection * p;\r
}\r
`;qe.ShadersStore.rippleFragmentShader=`precision highp float;\r
uniform mat4 worldView;\r
varying vec4 vPosition;\r
varying vec3 vNormal;\r
uniform vec4 color;\r
void main(void) {\r
    vec3 n = normalize( worldView * vec4(vNormal, 0.0) ).xyz;\r
    float y_ratio = vPosition.y / 1.;\r
    float brightness = (sin(abs(n.x)) + sin(y_ratio)) / 4.0;\r
    float r = clamp(color.x + brightness, 0.0, 1.0);\r
    float g = clamp(color.y + brightness, 0.0, 1.0);\r
    float b = clamp(color.z + brightness, 0.0, 1.0);\r
    float a = color.w;\r
    gl_FragColor = vec4( r, g, b, a );\r
}\r
`;function ze(e,t){const{position:n,volume_m3:o,shadow_generator:r,animation:a,bounce_animation_squidge:s=.05}=t;let{color:i}=t,_=Re(o);i=i.clone();let l=new q("material_gas",e);l.specularColor=new k(Math.min(i.r*.3,.2),Math.min(i.g*.3,.2),Math.min(i.b*.3,.2)),l.diffuseColor=new k(i.r,i.g,i.b);let c;a==="ripple"&&(c=new Lt("material_ripple_shader",e,{vertex:"ripple",fragment:"ripple"},{attributes:["position","normal","uv"],uniforms:["world","worldView","worldViewProjection","view","projection"]}),c.setFloat("time",0),c.setFloat("bubble_size",_),c.setColor4("color",i),c.backFaceCulling=!0);const f=10,m=40,b=new me("gas_bubble_container_position",e),h=new me("gas_bubble_container_scaling",e);b.addChild(h);const g=G.CreateIcoSphere("gas_bubble",{radius:1,subdivisions:5},e);g.visibility=i.a,h.addChild(g),h.scaling=y.One().scale(_),r&&(g.receiveShadows=!0,r.addShadowCaster(g)),g.material=c||l,b.position=new y(n.x,n.y+_,n.z);const O=new d("gas_bubble_animate_pos_y","position.y",f,d.ANIMATIONTYPE_FLOAT,d.ANIMATIONLOOPMODE_CYCLE);O.setKeys([{frame:0,value:n.y},{frame:m/2,value:n.y+_*.3},{frame:m,value:n.y}]);const S=new de;if(S.setEasingMode(ie.EASINGMODE_EASEINOUT),O.setEasingFunction(S),h.animations.push(O),a==="bounce"){const v=new d("gas_bubble_animate_scale","scaling",f,d.ANIMATIONTYPE_VECTOR3,d.ANIMATIONLOOPMODE_CYCLE),T=s,L=T/2,P=new y(1+T,1-T,1+T),$=y.One();v.setKeys([{frame:0,value:P.clone()},{frame:m*.25,value:new y(1-L,1+L,1-L)},{frame:m*.5,value:$.clone()},{frame:m*.8,value:$.clone()},{frame:m,value:P.clone()}]);const U=new de;U.setEasingMode(ie.EASINGMODE_EASEINOUT),v.setEasingFunction(U),g.animations.push(v)}const w={start_value:0,target_value:0,animating:!1,start_at:0};let x=!1,Y=()=>{x||(x=!0,e.beginAnimation(h,0,m,!0),e.beginAnimation(g,0,m,!0))},oe=(v=0)=>{v=$e(v,0,1);function T(){if(i.a===v)return;const L=v-i.a,P=Math.min(Math.abs(L),.05);P<.05?i.a=v:(i.a+=P*Math.sign(L),i.a=$e(i.a,0,1)),l.diffuseColor=new k(i.r,i.g,i.b),g.visibility=i.a,c==null||c.setColor4("color",i),setTimeout(T,50)}T()},re=(v,T=3e3)=>{if(w.start_value=_,w.target_value=Re(v),w.start_at=performance.now(),w.animating)return;w.animating=!0;function L(){const P=performance.now(),$=w.start_at+T;if(P>=$)_=w.target_value,w.animating=!1;else{const V=(P-w.start_at)/T*Math.PI,se=(1-Math.cos(V))/2;_=(w.target_value-w.start_value)*se+w.start_value,setTimeout(L,50)}b.position=new y(n.x,n.y+_,n.z),h.scaling=y.One().scale(_)}L()};return c&&(Y=()=>{e.beginAnimation(h,0,m,!0),e.beginAnimation(g,0,m,!0);let v=0;const T=setInterval(()=>{c==null||c.setFloat("time",v),v+=.05},50);g.onDispose=()=>clearTimeout(T)}),{gas_bubble_mesh:g,play:Y,opacity:oe,grow:re}}function Re(e){return Math.pow(e*.75/Math.PI,1/3)}function en(e,t,n){n=n||A([t/2,-1/2,t/2]);const r=new ee(.2,.3,0,1),a=new ee(.2,.15,0,1),s=[a,a,a,a,r,a],i=G.CreateBox("ground",{width:t,depth:t,height:1,faceColors:s},e);i.setPivotPoint(A([t/2,1/2,t/2])),i.position=A([0,-1/2,0]);const _=new me("ground_container");_.position=n,_.addChild(i);const l=new q("semimatt_material",e);l.specularColor=new k(.05,.05,.05),i.material=l,i.receiveShadows=!0;function c(f){const m=f/t;i.scaling=A([m,1,m])}return{ground:i,resize_ground:c}}function tn(e){e.clearColor=new ee(.443,.737,.945,1)}function nn(){const t=document.location.search.slice(1).split("&"),n={};return t.forEach(o=>{const r=o.split("="),a=decodeURIComponent(r[0]),s=decodeURIComponent(r[1]);n[a]=s}),n}function Z(e,t,n){var s;const o=(s=e[t])!=null?s:`${n}`;let r=n,a="";try{r=parseFloat(o)}catch{a=`Not a valid number: "${o}"`}return{value:r,error:a}}function ye(e,t,n){var o;return{value:(o=e[t])!=null?o:n,error:""}}function on(e){const t=Math.floor(Math.random()*e.length);return e[t]}function rn(e){e=[...e];let t=e.length;for(;t>0;){const n=Math.floor(Math.random()*t);--t,[e[n],e[t]]=[e[t],e[n]]}return e}const nt=["f_7","f_8","m_8"];function ve(e,t,n,o=""){o=o||on(nt);const r=Me(e,o,"person"+name,{position:n,receive_shadows:!0,shadow_generator:t,visibility:1});return t.addShadowCaster(r),r.receiveShadows=!0,r}var u=(e=>(e.undefined="undefined",e.time_period_year="time_period_year",e.time_period_month="time_period_month",e.time_period_day="time_period_day",e.time_period_second="time_period_second",e.energy_joule="energy_joule",e.energy_kWh="energy_kWh",e.energy_therm="energy_therm",e.energy_BTU="energy_BTU",e.volume_normal_m3="volume_normal_m3",e.volume_normal_cubic_feet="volume_normal_cubic_feet",e.currency_gbp="currency_gbp",e))(u||{});const We=Object.entries(u).filter(([e,t])=>e!==t);if(We.length)throw new Error(`Mismatching UnitsID keys and values: ${We.map(([e])=>e).join(",")}`);const j={undefined:{id:"undefined",name:"undefined",symbol:"?"},time_period_month:{id:"time_period_month",name:"month",symbol:"month"},time_period_year:{id:"time_period_year",name:"year",symbol:"year"},time_period_day:{id:"time_period_day",name:"day",symbol:"day"},time_period_second:{id:"time_period_second",name:"second",symbol:"s"},energy_joule:{id:"energy_joule",name:"joule",symbol:"J"},energy_kWh:{id:"energy_kWh",name:"kilowatt-hour",symbol:"kWh"},energy_therm:{id:"energy_therm",name:"therm",symbol:"thm"},energy_BTU:{id:"energy_BTU",name:"British Thermal Unit",symbol:"BTU"},volume_normal_m3:{id:"volume_normal_m3",name:"cubic meter",symbol:"m3"},volume_normal_cubic_feet:{id:"volume_normal_cubic_feet",name:"cubic feet",symbol:"ft3"},currency_gbp:{id:"currency_gbp",name:"Pound Stirling",symbol:"\xA3"}},Ge=Object.entries(j).filter(([e,t])=>e!==t.id);if(Ge.length)throw new Error(`Mismatching UNITS keys and values: ${Ge.map(([e])=>e).join(",")}`);function B(e){return typeof e=="string"}function an(e){return typeof e!="string"}function Ae(e){return B(e)?we(e):`${e.num.map(we).join(" ")} / ${e.denom.map(we).join(" ")}`}function we(e){return j[e].symbol}function Ce(e){return B(e)?[e]:[...e.num]}function Ne(e){return B(e)?[]:[...e.denom]}function ot(e){return{num:Ce(e),denom:Ne(e)}}function sn(e,t){return B(e)?B(t)?e===t:!1:B(t)?!1:Ue(e.num,t.num)&&Ue(e.denom,t.denom)}function Ue(e,t){if(e.length!==t.length)return!1;const n={};e.forEach(a=>n[a]=(n[a]||0)+1);const o={};return t.forEach(a=>o[a]=(o[a]||0)+1),!Object.entries(n).find(([a,s])=>o[a]!==s)}function Ie(e){if(B(e))return e;let{num:t,denom:n}=e;const o={};t.forEach(a=>o[a]=(o[a]||0)+1);const r={};return n.forEach(a=>{(o[a]||0)-(r[a]||0)<=0||(r[a]=(r[a]||0)+1)}),Object.entries(r).forEach(([a,s])=>{let i=0;t=t.filter(l=>l!==a||i>=s?!0:(++i,!1));let _=0;n=n.filter(l=>l!==a||_>=s?!0:(++_,!1))}),n.length===0&&t.length===1?t[0]:{num:t,denom:n}}function rt(e,t){let{num:n,denom:o}=ot(e.units);n=n.concat(Ne(t.units)),o=o.concat(Ce(t.units));const r=Ie({num:n,denom:o});return N(E({},e),{description:(e.description||"")+" / "+(t.description||""),value:e.value/t.value,units:r})}function at(e,t){if(!sn(e.units,t.units)){const o=`Units are not equal.  Can not subtract: "${Ae(e.units)}" and "${Ae(t.units)}"`;return{value:void 0,error:o}}return{value:N(E({},e),{value:e.value-t.value}),error:""}}function _n(e,t){let{num:n,denom:o}=ot(e.units);n=n.concat(Ce(t.units)),o=o.concat(Ne(t.units));const r=Ie({num:n,denom:o});return N(E({},e),{description:(e.description||"")+" * "+(t.description||""),value:e.value*t.value,units:r})}const it=24*3600*1e3;function st(e,t){return new Date(e.getTime()-t*it)}function _t(e){return(e.date_to.getTime()-e.date_from.getTime())/it}const te=365.25,ln=te/4,lt=te/12,ke=24*3600,Ee=ke*lt,cn=ke*te;function un(e){e=e.toLowerCase();let t,n="";return e==="annually"?t=Math.round(te):e==="quarterly"?t=Math.round(ln):e==="monthly"?t=Math.round(lt):e==="daily"?t=1:n=`Unsupported time period: "${e}"`,{value:t,error:n}}function mn(e){const t=_t(e);return t>=365&&t<=366}function dn(e){if(mn(e))return e;const t=_t(e),n=te/t,o=st(e.date_to,Math.round(te)),r=e.value*n;return N(E({},e),{date_from:o,value:r})}function ct(e,t){const n=Ie(e.units);if(B(n))return{value:void 0,error:`Must have units with time in denominator but got: "${JSON.stringify(n)}"`};const o=n.num.filter(f=>f.toString().startsWith("time_period_")),r=n.denom.filter(f=>f.toString().startsWith("time_period_"));if(o.length)return{value:void 0,error:`Not implemented supporting time units in numerator.  Have units: "${JSON.stringify(n)}"`};if(r.length!==1)return{value:void 0,error:`Not implemented supporting multiple time units in denominator.  Have units: "${JSON.stringify(n)}"`};const a=r[0];let s=0;if(a===u.time_period_day?s=ke:a===u.time_period_month?s=Ee:a===u.time_period_year&&(s=cn),s===0)return{value:void 0,error:`Not implemented supporting time units in demoninator of: "${a}"`};let i=1,_=[];return t==="month"?(i=Ee/s,_=[u.time_period_month]):t==="year"&&(i=Ee/s,_=[u.time_period_year]),{value:_n(e,{value:i,units:{num:[a],denom:_}}),error:""}}const fn={[j.energy_therm.id]:{[j.energy_joule.id]:105506e3,[j.volume_normal_m3.id]:2.851},[j.volume_normal_cubic_feet.id]:{[j.volume_normal_m3.id]:.02832}};function xe(e,t){let n,o="";const{units:r}=e;if(an(r))return o=`Can not yet convert compound units: "${JSON.stringify(r)}"`,{value:n,error:o};let a;if(B(r)&&(a=fn[r]),!a)return o=`No conversion map for units: "${r}"`,{value:n,error:o};const s=a[t];return s===void 0?(o=`No conversion factor from: "${r}" to "${t}"`,{value:n,error:o}):(n=N(E({},e),{value:e.value*s,units:t}),{value:n,error:o})}function ne(e){if(e.value===void 0)throw new Error(e.error||"No error specified");return e.value}const p={date_2019_01_01:new Date("2019-01-01"),date_2020_01_01:new Date("2020-01-01"),date_2021_01_01:new Date("2021-01-01"),date_2021_09_24:new Date("2021-09-24"),date_2021_11_04:new Date("2021-11-04"),date_2022_01_01:new Date("2022-01-01"),date_2022_01_04:new Date("2022-01-04"),date_2022_02_14:new Date("2022-02-14"),date_2022_03_01:new Date("2022-03-01"),date_2022_03_14:new Date("2022-03-14"),date_2022_03_28:new Date("2022-03-28"),date_2022_03_31:new Date("2022-03-31"),date_2022_04_01:new Date("2022-04-01"),date_2022_04_18:new Date("2022-04-18"),date_2022_04_19:new Date("2022-04-19"),date_2022_04_30:new Date("2022-04-30")},ue={_2021_09_24:{value:38827,units:u.volume_normal_cubic_feet,date:p.date_2021_09_24},_2021_11_04:{value:39245,units:u.volume_normal_cubic_feet,date:p.date_2021_11_04},_2022_01_04:{value:40311,units:u.volume_normal_cubic_feet,date:p.date_2022_01_04},_2022_03_28:{value:41474,units:u.volume_normal_cubic_feet,date:p.date_2022_03_28}},gn={_2022_04_18:{description:"This monthly gas charge would have come into effect much earlier, perhaps in 2021 or 2020",value:94.39,units:{num:[u.currency_gbp],denom:[u.time_period_month]},date:p.date_2022_04_18},_2022_04_19:{value:163.85,units:{num:[u.currency_gbp],denom:[u.time_period_month]},date:p.date_2022_04_19}},hn={_2022_04_19:{value:.0734,units:{num:[u.currency_gbp],denom:[u.energy_kWh]},date:p.date_2022_04_19}},pn={_2022_04_19:{value:.2722,units:{num:[u.currency_gbp],denom:[u.time_period_day]},date:p.date_2022_04_19}};u.energy_kWh,p.date_2021_09_24,u.energy_kWh,p.date_2021_11_04,u.energy_kWh,p.date_2022_01_04,u.energy_kWh,p.date_2022_03_28;u.currency_gbp,u.energy_kWh,p.date_2022_04_19;u.currency_gbp,u.time_period_day,p.date_2022_04_19;const bn=N(E({},ne(at(ue._2022_01_04,ue._2021_09_24))),{description:"Based on meter readings",date_from:ue._2021_09_24.date,date_to:ue._2022_01_04.date}),Ve=ne(xe(bn,u.volume_normal_m3));N(E({},Ve),{value:Ve.value*3});const yn={_2022_04_19:ne(ct(pn._2022_04_19,"year"))},vn={_2022_04_19:ne(ct(gn._2022_04_19,"year"))},wn={_2021:N(E({},ne(at(vn._2022_04_19,yn._2022_04_19))),{description:"Estimate for 2021 based on gas bill in 2022_04_19, cost of gas per kWH in 2022_04_29 and minus the standing charge in 2022_04_29."})};N(E({},rt(wn._2021,hn._2022_04_19)),{description:"Calculated indirectly from gas bill in 2022_04_19 minus the standing charge."});function En(e){return e instanceof Array?Mn(e,e.length-1):e}function Mn(e,t){return e instanceof Array?An(e,t):e}function An(e,t){if(t>=e.length){const r=`Attempting to get composed value from version "${t}", but only "${e.length}" versions available.`;console.error(r)}let n=0,o=e[0];for(;n<t;)++n,o=E(E({},o),e[n]);return o}const On=[{value:39.4,units:{num:[u.currency_gbp],denom:[u.energy_therm]},date_from:p.date_2019_01_01,date_to:p.date_2020_01_01},{value:.394,description:"Updated to fix error in value"}],Tn=[{value:24.7,units:{num:[u.currency_gbp],denom:[u.energy_therm]},date_from:p.date_2020_01_01,date_to:p.date_2021_01_01},{value:.247,description:"Updated to fix error in value"}],Cn=[{value:115,units:{num:[u.currency_gbp],denom:[u.energy_therm]},date_from:p.date_2021_01_01,date_to:p.date_2022_01_01},{value:1.15,description:"Updated to fix error in value"}],Nn={value:.0397,units:{num:[u.currency_gbp],denom:[u.energy_kWh]},date_from:p.date_2022_02_14,date_to:p.date_2022_03_14,description:"EON domestic gas price"},In={average_annual:{uk:{average_uk_gas_price_2019:On,average_uk_gas_price_2020:Tn,average_uk_gas_price_2021:Cn}},supplier_eon:{uk:{uk_gas_price_2022_02_supplier_eon:Nn}}},kn={description:"Based off memory and estimate for heating, hot water and cooking",value:800,units:u.currency_gbp,date_from:p.date_2019_01_01,date_to:p.date_2020_01_01};u.currency_gbp,p.date_2022_02_14,p.date_2022_03_14;u.volume_normal_m3,p.date_2022_02_14,p.date_2022_03_14;const xn=N(E({},rt(kn,En(In.average_annual.uk.average_uk_gas_price_2019))),{description:"Estimate based off 2019 estimate of gas bill"});N(E({},ne(xe(xn,u.volume_normal_m3))),{description:"Estimate based off 2019 estimate of estimated gas bill with calculation of therms given average uk gas price"});new Ke;const Sn="low_poly_house_2",Ln="low_poly_house_2_chimney";function Pn(e,t,n,o){Me(e,Sn,"house_"+o,{position:n,receive_shadows:!0,shadow_generator:t,visibility:1}),Me(e,Ln,"house_chimney"+o,{position:n,receive_shadows:!0,shadow_generator:t,visibility:1})}function ut(e){const{tolerance_ms:t=20}=e;let{attempts_remaining:n=5}=e;if(n<=0){console.warn(`Failed to start funktion: "${e.funktion.toString()}" on time`),e.funktion();return}const{with_in_tolerance:o,diff_ms:r}=Dn(N(E({},e),{tolerance_ms:t}));if(o){e.funktion();return}const{aim_for_next_cycle:a,wait_for:s}=Fn({diff_ms:r,loop_ms:e.loop_ms});setTimeout(()=>{n=n+(a?-1:0),ut(N(E({},e),{tolerance_ms:t,attempts_remaining:n}))},s)}function Dn(e){const t=(performance.now()-e.start_ms)%e.loop_ms,n=e.delay_ms-t;return{with_in_tolerance:Math.abs(n)<=e.tolerance_ms,diff_ms:n}}function Fn(e){const t=e.diff_ms<0,n=t?e.loop_ms+e.diff_ms:e.diff_ms;return{aim_for_next_cycle:t,wait_for:n}}let ae;function Bn(e,t,n){ae||(ae=new q("smoke",e),ae.specularColor=new k(0,0,0),ae.diffuseColor=new k(.7,.7,.7));const{emit_position1:o,number:r=20,lifetime:a=10,speed:s=.5}=t,i=10,_=i*a,l=a*1e3,c=[];let f=0;for(;f<r;){const b=new me("smoke_container_"+f),h=G.CreateIcoSphere("smoke_"+f,{radius:.2,subdivisions:2},e);n&&(h.receiveShadows=!0,n.addShadowCaster(h)),b.addChild(h),b.rotateAround(o,new y(Math.random(),0,Math.random()),(Math.random()-.5)*.4),h.material=ae,h.position=o.clone();const g=new d("smoke_animate_pos_y_"+f,"position.y",i,d.ANIMATIONTYPE_FLOAT,d.ANIMATIONLOOPMODE_CYCLE);g.setKeys([{frame:0,value:o.y},{frame:_,value:o.y+s*a}]),h.animations.push(g);const O=new d("smoke_animate_opacity_"+f,"visibility",i,d.ANIMATIONTYPE_FLOAT,d.ANIMATIONLOOPMODE_CYCLE),S=.9+Math.random()/10;O.setKeys([{frame:0,value:1},{frame:_*.8*S,value:1},{frame:_*S,value:0},{frame:_,value:0}]),h.animations.push(O);const w=new d("smoke_animate_scale_"+f,"scaling",i,d.ANIMATIONTYPE_VECTOR3,d.ANIMATIONLOOPMODE_CYCLE);w.setKeys([{frame:0,value:y.One()},{frame:_,value:y.One().scale(3)}]),h.animations.push(w);const x=f/r*l;c.push({mesh:h,delay_ms:x}),++f}function m(){const b=performance.now();c.forEach(({mesh:h,delay_ms:g})=>{ut({funktion:()=>e.beginAnimation(h,0,_,!0),delay_ms:g,loop_ms:l,start_ms:b})})}return{play:m}}const mt=3;function Yn(e,t,n,o=mt){const{far_apex:r,x_point:a,z_point:s}=dt(n,t),i=D(e,{point1:r,point2:a,height:o}),_=D(e,{point1:r,point2:s,height:o});return[i,_]}function dt(e,t){const n=e**.5,o=t.subtract(A([n,0,n])),r=t.subtract(A([n,0,0])),a=t.subtract(A([0,0,n]));return{far_apex:o,x_point:r,z_point:a}}let z,R,W;function ft(e){z||(z=new q("red_a50",e),z.diffuseColor=k.Red(),z.alpha=.5,z.backFaceCulling=!1,z.specularColor=k.Black()),R||(R=new q("green_a50",e),R.diffuseColor=k.Green(),R.alpha=.5,R.backFaceCulling=!1,R.specularColor=k.Black()),W||(W=new q("blue_a50",e),W.diffuseColor=k.Blue(),W.alpha=.5,W.backFaceCulling=!1,W.specularColor=k.Black())}function D(e,{point1:t,point2:n,height:o,color:r="red"}){ft(e);const a=n.subtract(t),s=a.length(),i=G.CreatePlane("wall",{width:s,height:o},e),_=A([-s/2,-o/2,0]);i.setPivotPoint(_),i.position=t.subtract(_);const l=-Math.atan(a.z/a.x)+(a.x<0?Math.PI:0);return i.rotation=A([0,l,0]),i.material=r==="red"?z:r==="blue"?W:R,i}function He(e,{points:t,height:n,color:o="red"}){ft(e);const r=G.CreatePolygon("area_base",{shape:t},e,Pt),a=A([0,n,0]);return r.position=a,r.material=o==="red"?z:o==="blue"?W:R,r}function $n(e,t,n,o,r={}){var c,f;const a=(c=r.height)!=null?c:mt,s=(f=r.base_height)!=null?f:.1,_={current:je(e,t,n,a,o,s)};let l=!0;return{toggle_visible:()=>{l=!l,_.current.forEach(m=>{m.enablePointerMoveEvents=l,m.visibility=l?1:0})},is_visible:()=>l,update_bounding_area_m2:m=>{_.current.forEach(b=>b.dispose()),_.current=je(e,t,m,a,o,s)}}}function je(e,t,n,o,r,a){const s=Yn(e,t,n,o),i=r**.5,{x_point:_,z_point:l,far_apex:c}=dt(n,t),{x_far_point:f,far_far_apex:m,z_far_point:b}=zn(t,i);s.push(D(e,{point1:_,point2:f,height:o})),s.push(D(e,{point1:f,point2:m,height:o})),s.push(D(e,{point1:l,point2:b,height:o})),s.push(D(e,{point1:b,point2:m,height:o}));const h=[_,c,l,b,m,f];s.push(He(e,{points:h,height:a}));const g=t;s.push(D(e,{point1:g,point2:_,height:o,color:"green"})),s.push(D(e,{point1:_,point2:c,height:o,color:"green"})),s.push(D(e,{point1:g,point2:l,height:o,color:"green"})),s.push(D(e,{point1:l,point2:c,height:o,color:"green"}));const O=[g,_,c,l];return s.push(He(e,{points:O,height:a,color:"green"})),s}function zn(e,t){const n=e.subtract(A([t,0,t])),o=e.subtract(A([t,0,0])),r=e.subtract(A([0,0,t]));return{x_far_point:o,far_far_apex:n,z_far_point:r}}const X=24,K=1*X;function Rn(e,t,n={}){var b,h,g;const o=(b=n.alpha)!=null?b:t.alpha,r=(h=n.beta)!=null?h:t.beta,a=(g=n.radius)!=null?g:t.radius,s=new d("animation_camera_alpha","alpha",X,d.ANIMATIONTYPE_FLOAT,d.ANIMATIONLOOPMODE_CYCLE),i=new d("animation_camera_beta","beta",X,d.ANIMATIONTYPE_FLOAT,d.ANIMATIONLOOPMODE_CYCLE),_=new d("animation_camera_radius","radius",X,d.ANIMATIONTYPE_FLOAT,d.ANIMATIONLOOPMODE_CYCLE),l=[{frame:0,value:t.alpha},{frame:K,value:o}],c=[{frame:0,value:t.beta},{frame:K,value:r}],f=[{frame:0,value:t.radius},{frame:K,value:a}];s.setKeys(l),i.setKeys(c),_.setKeys(f);const m=new de;return m.setEasingMode(ie.EASINGMODE_EASEINOUT),s.setEasingFunction(m),i.setEasingFunction(m),_.setEasingFunction(m),e.beginDirectAnimation(t,[s,i,_],0,K,!1)}function Wn(e,t,n,o={}){let r=t.position.clone();if(o.max_distance!==void 0||o.keep_angle){let a=t.position.subtract(n);o.keep_angle&&(a=t.position.subtract(t.target));const s=o.max_distance===void 0?1:o.max_distance/a.length();(s<1||o.keep_angle)&&(r=n.add(a.scale(s)))}return gt(e,t,n,r)}function Gn(e,t,n){const o=t.fov,r=n.getBoundingInfo().boundingSphere,s=r.radiusWorld/Math.tan(o/2);let i=t.position.subtract(t.target);return i=i.normalize().scale(s),i.addInPlace(r.centerWorld),gt(e,t,r.centerWorld,i)}function gt(e,t,n,o){const r=n.subtract(t.target);o=o||t.position.add(r);const a=new d("animation_camera_target","target",X,d.ANIMATIONTYPE_VECTOR3,d.ANIMATIONLOOPMODE_CYCLE),s=new d("animation_camera_position","position",X,d.ANIMATIONTYPE_VECTOR3,d.ANIMATIONLOOPMODE_CYCLE),i=[{frame:0,value:t.target.clone()},{frame:K,value:n}],_=[{frame:0,value:t.position.clone()},{frame:K,value:o}];a.setKeys(i),s.setKeys(_);const l=new de;return l.setEasingMode(ie.EASINGMODE_EASEINOUT),a.setEasingFunction(l),s.setEasingFunction(l),e.beginDirectAnimation(t,[a,s],0,K,!1)}function Un(e={}){const t={};function n(a,s){const i=e[a];if(i){const c=i(s);if(!c.continue)return;s=c.message}const _=t[a];(_===void 0?[]:_).forEach(c=>{setTimeout(()=>c(s),0)})}function o(a,s){const i=t[a],_=i===void 0?[]:i;return _.push(s),t[a]=_,r(a,s)}function r(a,s){return()=>{const i=t[a],l=(i===void 0?[]:i).filter(c=>c!==s);t[a]=l}}return{pub:n,sub:o}}const Vn=Un(),I={ui:Vn},Hn=200;function jn(e,t,n){let o=0;e.onPointerObservable.add(r=>{if(r.type===Ye.POINTERDOWN){const a=performance.now()-o<Hn;o=performance.now(),a&&Kn(r,n,e,t)}else r.type,Ye.POINTERMOVE})}function Kn(e,t,n,o){var r,a;if(((r=e.pickInfo)==null?void 0:r.hit)&&((a=e.pickInfo.pickedMesh)==null?void 0:a.position)){let s=new y;const _=t.thinInstanceGetWorldMatrices()[e.pickInfo.thinInstanceIndex];_?_.getTranslationToRef(s):s=e.pickInfo.pickedMesh.position.clone(),Wn(n,o,s,{max_distance:void 0,keep_angle:!0})}}function qn(e,t){const n=new Je;n.width="220px",n.horizontalAlignment=fe.HORIZONTAL_ALIGNMENT_LEFT,n.verticalAlignment=fe.VERTICAL_ALIGNMENT_TOP,e.addControl(n);const o=new H;o.text=t,o.height="30px",o.color="white",n.addControl(o)}function Jn(e,t){const n=Qe.CreateFullscreenUI("UI",!0,e),o=new Je;o.width="220px",o.horizontalAlignment=fe.HORIZONTAL_ALIGNMENT_RIGHT,o.verticalAlignment=fe.VERTICAL_ALIGNMENT_TOP,n.addControl(o);const r=new H;r.text=`Gas consumption
in ${Ae(t.units)} per year`,r.height="50px",r.color="white",o.addControl(r);const a=new H,s=Number(t.value.toPrecision(2));a.text=`${s}`;const i=n.createStyle();i.fontSize=30,a.style=i,a.height="50px",a.color="white",o.addControl(a);const _=new H;_.text="Visualise",_.height="30px",_.color="blue",o.addControl(_),M("ui_toggle_show_natural_gas_bubble","Show gas",o,{width:.5}),M("ui_toggle_show_co2_bubble","Show CO2",o,{width:.5});const l=new H;l.text="Individual Action",l.height="30px",l.color="orange",o.addControl(l),M("ui_toggle_action_improve_insulation","More efficient radiators",o),M("ui_toggle_action_improve_insulation",'"Smart" radiators',o),M("ui_toggle_action_improve_insulation","Gas boiler",o),M("ui_toggle_action_improve_insulation","Wood stove",o,{color:"grey"}),M("ui_toggle_action_improve_insulation","Heat pump",o,{color:"grey"}),M("ui_toggle_action_improve_insulation","Draft excluders",o,{color:"grey"}),M("ui_toggle_action_improve_insulation","Improve insulation",o,{color:"grey"}),M("ui_toggle_action_improve_insulation","Double glazing",o,{color:"grey"});const c=new H;c.text="Systemic Action",c.height="30px",c.color="orange",o.addControl(c),M("ui_toggle_action_protect_trees","Protect trees",o),I.ui.sub("ui_toggle_action_protect_trees",()=>m()),I.ui.sub("ui_toggle_action_plant_trees",()=>m());let f=!1;function m(){if(f)return;f=!0;const b=new H;b.text="Forest area constraints",b.height="30px",b.color="blue",o.addControl(b),M("ui_toggle_show_forest_area_constraint_personal_property_area","Personal property",o),M("ui_toggle_show_forest_area_constraint_existing_forest_country_area","Existing Forest Country Area per Home",o,{height:45,width:1}),M("ui_toggle_show_forest_area_constraint_max_forestable_country_area","Max Forestable Country Area per Home",o,{height:45,width:1}),M("ui_toggle_show_forest_area_constraint_max_forestable_city_plus_country_area","Max Forestable + City Trees Country Area per Home",o,{height:45,width:1})}}function M(e,t,n,o={}){var a,s,i;const r=Dt.CreateSimpleButton("button_"+e,t);r.width=(a=o.width)!=null?a:.7,r.height=`${(s=o.height)!=null?s:30}px`,r.color=(i=o.color)!=null?i:"white",r.onPointerClickObservable.add(()=>{I.ui.pub(e,void 0)}),n.addControl(r)}const Qn=({scene:e,camera:t,shadow_generator:n},o,r)=>{tn(e);const a=A([o/2,-.5,o/2]),{ground:s,resize_ground:i}=en(e,o,a),_=ze(e,{position:new y(10,2,-2),volume_m3:0,color:new ee(.25,.3,.5,.8),shadow_generator:n});_.play(),_.gas_bubble_mesh.setEnabled(!1);const l=ze(e,{position:new y(0,4,-2),volume_m3:0,color:new ee(.5,.05,0,.8),shadow_generator:n});l.play(),l.gas_bubble_mesh.setEnabled(!1);const c=rn(nt);ve(e,n,new y(-4,0,3),c[0]),ve(e,n,new y(0,0,5),c[1]),ve(e,n,new y(2,0,4),c[2]),Pn(e,n,y.Zero(),"house");const{play:f}=Bn(e,{emit_position1:new y(.5,4.2,-1.9)},n);f();const m={gas_period:ye(r,"gas_period"),gas_volume:Z(r,"gas"),gas_units:ye(r,"gas_units"),name:ye(r,"name"),home_footprint_m2:Z(r,"home_footprint_m2"),home_property_m2:Z(r,"home_property_m2"),forest_kg_co2_per_m2_per_year:Z(r,"forest_co2_absorb"),mangrove_kg_co2_per_m2_per_year:Z(r,"mangrove_co2_absorb"),peatland_kg_co2_per_m2_per_year:Z(r,"peatland_co2_absorb")},b={};let h=!1;if(Object.keys(m).forEach(C=>{const F=m[C];F.value===void 0?(console.error(`Error in "${C}" param`,F.error),h=!0):b[C]=F.value}),h)return;const{name:g,gas_period:O,gas_volume:S,gas_units:w,forest_kg_co2_per_m2_per_year:x,home_footprint_m2:Y,home_property_m2:oe}=b,re=oe-Y,v=242495*1e6/(27.8*1e6),T=v*.098,L=v*.831,P=v*.861,$=Zn({gas_period:O,gas_volume:S,gas_units:w});if($.value===void 0){console.error("Error in gas params",$.error);return}const U=to($.value);if(U.value===void 0){console.error("Error converting gas to m3 per year",U.error);return}const V=U.value;I.ui.sub("ui_toggle_show_natural_gas_bubble",()=>{const C=!_.gas_bubble_mesh.isEnabled();_.gas_bubble_mesh.setEnabled(C),_.grow(V.value)}),I.ui.sub("ui_toggle_show_co2_bubble",()=>{const C=!l.gas_bubble_mesh.isEnabled();l.gas_bubble_mesh.setEnabled(C),l.grow(V.value)}),I.ui.sub("ui_toggle_show_co2_bubble__max",()=>{const C=!l.gas_bubble_mesh.isEnabled();l.gas_bubble_mesh.setEnabled(C),l.grow(V.value*1.16)});const se=new y(-5,0,-5),ge=V.value/x;console.log("forest_m2",ge);const Se=Math.round(Math.pow(ge,.5));let{tree_nodes:Le,play:bt}=Xt(e,n,se,Se),_e=!1;const yt=.2;I.ui.sub("ui_toggle_action_protect_trees",()=>{_e||(_e=!0,Pe())}),I.ui.sub("ui_toggle_action_plant_trees",()=>{Le.forEach(C=>{const F=y.One().scale(yt);C.getChildMeshes().forEach(pe=>pe.scaling=F.clone())}),!_e&&(_e=!0,Pe())});function Pe(){i(Se+o),setTimeout(()=>{Gn(e,t,s),setTimeout(()=>bt(),1e3)},50)}I.ui.sub("ui_toggle_show_tree_CO2_absorbed",()=>{});let le="",he=0;const J=$n(e,se,he,ge,{height:8,base_height:8});J.toggle_visible();function ce(C,F){return()=>{const pe=!!le&&le===C;if(J.is_visible()?pe&&(J.toggle_visible(),le=""):J.toggle_visible(),J.is_visible()){le=C;const wt=he!==F;he=F,Rn(e,t,{alpha:Math.PI/2,beta:0}),wt&&J.update_bounding_area_m2(F)}}}I.ui.sub("ui_toggle_show_forest_area_constraint_personal_property_area",ce("personal",re)),I.ui.sub("ui_toggle_show_forest_area_constraint_existing_forest_country_area",ce("existing_forest",T)),I.ui.sub("ui_toggle_show_forest_area_constraint_max_forestable_country_area",ce("max_forestable",L)),I.ui.sub("ui_toggle_show_forest_area_constraint_max_forestable_city_plus_country_area",ce("existing_forest_city_plus",P));const vt=Qe.CreateFullscreenUI("UI",!0,e);qn(vt,g),Jn(e,V),jn(e,t,Le[0])};function Zn(e){const{gas_period:t,gas_volume:n,gas_units:o}=e;let r;const a=un(t);if(a.value===void 0)return{value:r,error:a.error};const s=Xn(o);if(s.value===void 0)return{value:r,error:s.error};const i=new Date,_=st(i,a.value);return r={value:n,units:s.value,date_from:_,date_to:i},{value:r,error:""}}function Xn(e){e=e.toLowerCase();let{value:t,error:n}=eo(e);return t||(e==="kwh"?t=u.energy_kWh:n=`Unsupported gas volume units: "${e}"`),{value:t,error:n}}function eo(e){e=e.toLowerCase();let t=u.undefined,n="";return e==="m3"?t=u.volume_normal_m3:e==="ft3"?t=u.volume_normal_cubic_feet:n=`Unsupported volume units: "${t}"`,{value:t,error:n}}function to(e){let t=e,n="";return t.units!==u.volume_normal_m3&&({value:t,error:n}=xe(t,u.volume_normal_m3),t===void 0)?{value:t,error:n}:(t=dn(t),{value:t,error:n})}const no=nn(),oo=({scene:e,camera:t,sun:n,shadow_generator:o})=>{t.upperBetaLimit=Math.PI/2*.99,Qn({scene:e,camera:t,sun:n,shadow_generator:o},20,no)};class ht{constructor(t){Q(this,"engine");Q(this,"scene");Q(this,"assets_manager");Q(this,"camera");Q(this,"sun");this.canvas=t,this.engine=new Ft(t,!0,{stencil:!0}),window.addEventListener("resize",()=>{this.engine.resize()});const n=ro(this.engine,this.canvas);this.scene=n.scene,this.camera=n.camera,this.sun=n.sun,this.assets_manager=new Bt(this.scene),Vt(this.assets_manager)}debug(t){window.scene=this.scene,t?this.scene.debugLayer.show({overlay:!0}):this.scene.debugLayer.hide(),window.show_debug=()=>this.scene.debugLayer.show({overlay:!0})}run(){this.debug(!1),this.assets_manager.load(),this.assets_manager.onFinish=t=>{const n=Gt(this.scene);oo({scene:this.scene,camera:this.camera,sun:this.sun,shadow_generator:n}),this.engine.runRenderLoop(()=>{this.scene.render()})}}}function ro(e,t){var n=new Yt(e);n.clearColor=new ee(0,0,0,1);const o=new $t("orbitalCamera",Math.PI/3,Math.PI/3,30,new y(0,0,0),n);o.attachControl(t,!0),o.lowerRadiusLimit=3,o.useBouncingBehavior=!0;const r=Rt(n);return{scene:n,camera:o,sun:r}}console.log(`main.ts starting ${ht.name}`);window.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("renderCanvas");new ht(e).run()});
